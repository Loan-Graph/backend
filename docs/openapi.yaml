openapi: 3.0.3
info:
  title: LoanGraph Backend API
  version: 0.2.0
  description: Backend bootstrap + cookie-based auth with Privy token bootstrap.
servers:
  - url: http://localhost:8090
paths:
  /health:
    get:
      summary: Liveness endpoint
      responses:
        '200':
          description: Service is alive
  /ready:
    get:
      summary: Readiness endpoint with DB check
      responses:
        '200':
          description: Service and DB are ready
        '503':
          description: Service is not ready
  /v1/meta:
    get:
      summary: Service metadata endpoint
      responses:
        '200':
          description: Metadata response
  /v1/auth/privy/login:
    post:
      summary: Login using Privy access token and issue backend auth cookies
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [privy_access_token]
              properties:
                privy_access_token:
                  type: string
      responses:
        '200':
          description: Login success
        '401':
          description: Authentication failed
  /v1/auth/refresh:
    post:
      summary: Rotate refresh cookie and issue new access/refresh cookies
      responses:
        '200':
          description: Refreshed
        '401':
          description: Refresh failed
  /v1/auth/logout:
    post:
      summary: Revoke session and clear cookies
      responses:
        '200':
          description: Logged out
  /v1/auth/me:
    get:
      summary: Get current authenticated user
      responses:
        '200':
          description: User profile
        '401':
          description: Unauthorized
  /admin/system/health:
    get:
      summary: Admin-only system health endpoint
      responses:
        '200':
          description: Admin health response
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (insufficient role)
  /admin/lenders:
    post:
      summary: Onboard a lender (admin only)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, country_code, wallet_address]
              properties:
                name: { type: string }
                country_code: { type: string }
                wallet_address: { type: string }
                kyc_status: { type: string }
                tier: { type: string }
      responses:
        '201':
          description: Lender created
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
  /admin/lenders/{lenderId}/status:
    patch:
      summary: Update lender KYC status (admin only)
      parameters:
        - in: path
          name: lenderId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [kyc_status]
              properties:
                kyc_status: { type: string }
      responses:
        '200':
          description: Status updated
        '400':
          description: Invalid request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
  /v1/loans/upload:
    post:
      summary: Upload a lender loan book CSV and queue on-chain registration jobs
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [lender_id, file]
              properties:
                lender_id:
                  type: string
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Upload processed successfully
        '400':
          description: Validation failure in request or CSV content
        '401':
          description: Unauthorized
        '403':
          description: Forbidden (insufficient role)
  /v1/loans:
    get:
      summary: List loans for a lender
      parameters:
        - in: query
          name: lender_id
          schema: { type: string }
        - in: query
          name: status
          schema: { type: string }
        - in: query
          name: risk_grade
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer }
        - in: query
          name: offset
          schema: { type: integer }
      responses:
        '200':
          description: Loan list
  /v1/loans/{loanId}:
    get:
      summary: Get a single loan by id
      parameters:
        - in: path
          name: loanId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Loan object
        '404':
          description: Loan not found
  /v1/loans/{loanId}/repay:
    post:
      summary: Record a loan repayment and enqueue on-chain sync job
      parameters:
        - in: path
          name: loanId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [amount_minor, currency]
              properties:
                amount_minor: { type: integer }
                currency: { type: string }
      responses:
        '200':
          description: Repayment accepted
        '400':
          description: Invalid repayment request
  /v1/loans/{loanId}/default:
    post:
      summary: Mark a loan default and enqueue on-chain sync job
      parameters:
        - in: path
          name: loanId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                reason: { type: string }
      responses:
        '200':
          description: Default accepted
        '400':
          description: Invalid default request
  /v1/portfolio/analytics:
    get:
      summary: Portfolio analytics for a lender
      parameters:
        - in: query
          name: lender_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Portfolio analytics response
        '400':
          description: Invalid request
  /v1/portfolio/health:
    get:
      summary: Portfolio health (score distribution) for a lender
      parameters:
        - in: query
          name: lender_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Portfolio health response
        '400':
          description: Invalid request
  /v1/passport/{borrowerHash}:
    get:
      summary: Get borrower passport cache by borrower hash
      parameters:
        - in: path
          name: borrowerHash
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Passport response
        '404':
          description: Passport not found
  /v1/passport/{borrowerHash}/history:
    get:
      summary: Get borrower loan history by borrower hash
      parameters:
        - in: path
          name: borrowerHash
          required: true
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer }
        - in: query
          name: offset
          schema: { type: integer }
      responses:
        '200':
          description: Loan history response
        '404':
          description: Borrower history not found
  /v1/passport/{borrowerHash}/nft:
    get:
      summary: Get borrower passport NFT metadata response
      parameters:
        - in: path
          name: borrowerHash
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Passport NFT response
        '404':
          description: Passport NFT not found
  /v1/pools:
    get:
      summary: List investor pools
      parameters:
        - in: query
          name: lender_id
          schema: { type: string }
        - in: query
          name: currency
          schema: { type: string }
        - in: query
          name: status
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer }
        - in: query
          name: offset
          schema: { type: integer }
      responses:
        '200':
          description: Pool list response
  /v1/pools/{poolId}:
    get:
      summary: Get pool details
      parameters:
        - in: path
          name: poolId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Pool details response
        '404':
          description: Pool not found
  /v1/pools/{poolId}/performance:
    get:
      summary: Get pool repayment performance time series
      parameters:
        - in: path
          name: poolId
          required: true
          schema: { type: string }
        - in: query
          name: days
          schema: { type: integer }
      responses:
        '200':
          description: Pool performance response
        '400':
          description: Invalid request
  /v1/lenders/{lenderId}/profile:
    get:
      summary: Get lender public profile
      parameters:
        - in: path
          name: lenderId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Lender profile response
        '404':
          description: Lender not found
